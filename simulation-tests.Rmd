---
title: "Testing a process model with patches and stage structure on simulated data"
author: "Alexa Fredston, Dan Ovando, Malin Pinsky"
date: "Begun Jan 2021"
output:
  pdf_document: default
  html_document: default
---

This document can be considered a sequel to `stage-simulation.Rmd`, where we developed a "minimum viable product" process model with all parameters input as data. This also means the calculation of growth rates as a function of temperature happens in the Stan model code, not in the R code (where we previously just calculated the growth rate). 

# Estimating unknown parameters

In reality, we don't know these parameters, so let's start having the model estimate them:

* m, natural mortality
* width, sensitivity to temperature variation
* Topt,  temp at which growth is maximized

## Simulate the data

Some notes on this model:

* gY = gA
* Should growth rates be lagged by a year?
* Not estimating spillover yet 

```{r packages}
set.seed(42)
library(tidyverse)
library(tidybayes)

library(here)

library(rstan)
```


```{r simulate data}
patches <- 12

m <- 0.2 

stages <- 3

years <- 100
years_train <- 80
years_proj <- 20

alpha <- 0.5

sigma_r <- 0.2

mean_rec <- rlnorm(patches, log(20),1)

n0 <- mean_rec * matrix(rep(exp(-m * (0:(stages - 1))),patches), nrow = patches, ncol = stages, byrow = TRUE)

width <- 4 # sensitivity to temperature variation 

sstopt <- 18 # temp at which growth is maximized

growth <- function(sst) {exp(-0.5 * ((sst - sstopt)/width)^2)}
plot(seq(1, 100, 1), growth(seq(1, 100, 1))) # check how this works

spill <- 0.1

sst <- array(NA, dim = c(patches, years))
gY <- array(NA, dim = c(patches, years))
gA <- array(NA, dim = c(patches, years))

tmp <- sort(1:patches, decreasing=TRUE) # flip order so the highest sst is at the lowest patches (representing lat)
for(p in 1:patches){
  for(y in 1:years){
    
    if(y < 50){
      sst[p, y] <- rnorm(n=1, mean=(tmp[p]+10), sd=3)
    } # adding vaguely realistic SSTs for the mid-Atlantic
    
    else{
      sst[p, y] <- rnorm(n=1, mean=(tmp[p]+10), sd=3)*exp(y / 200) # adding warming; rescaling exponent to something sane
    }
    gY[p, y] <- growth(sst[p, y]) # calculate array of growth rates 
    gA[p, y] <- growth(sst[p, y]) 
  }
}

pop <- array(NA, dim = c(patches, stages, years))

pop[,,1] <- round(n0) # initialize first year  

for (y in 2:years){
  for(p in 1:patches) {
    # recruits
    pop[,1,y] <- round(mean_rec * exp(rnorm(patches,-sigma_r^2/2, sigma_r)))
    
    # young adults / large juvs
    pop[p,2,y] <- round(pop[p,1,y-1] * (1 - m) * gY[p, y-1]) + # recruits, less mortality, plus growth into this stage
      round(pop[p,2,y-1] * (1 - m) * (1 - gA[p, y-1])) # this life stage last year less individuals that died or grew out 
    
    # adults
    
    # add reflecting cases for edge patches
    if(p == 1) {
      pop[p,3,y] <- round(pop[p,2,y-1] * (1 - m) * gA[p, y-1]) + # growth from young adults in patch
        round(pop[p,3,y-1] * (1 - m) * (1 - spill)) + # adults in patch, minus mortality and spillover (only to one patch)
        round(pop[p+1,3,y-1] * (1 - m) * spill) # and patch above
    }
    
    else if(p == patches) {
      pop[p,3,y] <- round(pop[p,2,y-1] * (1 - m) * gA[p, y-1]) + # growth from young adults in patch
        round(pop[p,3,y-1] * (1 - m) * (1 - spill)) + # adults in patch, minus mortality and spillover (only to one patch)
        round(pop[p-1,3,y-1] * (1 - m) * spill) # and patch below
    }
    
    else{
      pop[p,3,y] <- round(pop[p,2,y-1] * (1 - m) * gA[p, y-1]) + # growth from young adults in patch
        round(pop[p,3,y-1] * (1 - m) * (1 - 2*spill)) + # adults in patch, minus mortality and spillover x2
        round(pop[p-1,3,y-1] * (1 - m) * spill) + # add dispersal from patch below
        round(pop[p+1,3,y-1] * (1 - m) * spill) # and patch above
    }
  }
}

popdf <- pop %>% 
  reshape::melt(varnames = c("patch","stage","year")) %>% 
  as.data.frame() %>% 
  mutate(stage = factor(stage))

# plot lat temp gradient

sst %>% 
  reshape::melt(varnames=c("patch","year")) %>% 
  ggplot(aes(x=year, y=value, color=value)) + 
  facet_wrap(~patch) + 
  geom_line() +
  labs(y="sst")

popdf %>% 
  ggplot(aes(x=year, y=value, color=stage)) + 
  geom_line() + 
  facet_wrap(~patch) +
  theme_bw() +
  scale_color_manual(values=c('blue','deeppink','cyan')) +
  labs(y="abundance")
```

## Fit a model 

```{r fit model}

stage_data <- list(
  sst = sst[, 1:years_train],
  sst_proj = sst[, (years_train+1):years],
  spill = spill,
  np = patches,
  ns = stages,
  ny = years_train,
  n_p_s_y = pop[,,1:years_train],
  proj_init = pop[,,years_train],
  ny_proj = years_proj
)

warmups <- 1000

total_iterations <- 2000

max_treedepth <-  12

n_chains <-  4

n_cores <- 4 

stage_model_fit <- stan(file = here::here("src","T_dep_growth_est_params.stan"), # check that it's the right model!
           data = stage_data,
           chains = 1, # add more later
           warmup = 1,
           iter = total_iterations,
           cores = n_cores,
           refresh = 250,
           control = list(max_treedepth = max_treedepth,
                          adapt_delta = 0.95))


```