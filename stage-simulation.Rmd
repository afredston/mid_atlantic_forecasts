---
title: "Simulating a process model with patches and stage structure"
author: "Alexa Fredston, Dan Ovando, Malin Pinsky"
date: "Begun Jan 2021"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r}
set.seed(42)
library(tidyverse)
library(rstan)
library(tidybayes)
library(bayesplot)
library(ggridges)
```

Simulate a population with simple stage structure

* Autoregressive recruitment process
* All individuals transition stages every year, modulated by a fixed mortality rate
* Adults do not accumulate (implies death after reaching adulthood)
* No dispersal

```{r prep}
patches <- 12

m <- 0.2 # I use this slightly differently in later sims (not exponentiated anymore)

stages <- 3

years <- 100
# years_train <- 25
# years_proj <- 5

alpha <- 0.5

sigma_r <- 0.2

mean_rec <- rlnorm(patches, log(20),1)

hist(mean_rec)

n0 <- mean_rec * matrix(rep(exp(-m * (0:(stages - 1))),patches), nrow = patches, ncol = stages, byrow = TRUE)
```

```{r sim-ar-simple-stage}

# generate data

pop <- array(NA, dim = c(patches, stages, years))

pop[,,1] <- round(n0) # initialize first year  

for (y in 2:years){
  
  pop[,1,y] <- round(mean_rec * exp(rnorm(patches,-sigma_r^2/2, sigma_r))) # add recruits
  
  pop[,2:stages,y] <-   round(pop[,1:(stages-1),y-1] * exp(-m)) # currently assuming all individuals advance to the next stage every year 
  
}

popdf <- pop %>% 
  reshape::melt(varnames = c("patch","stage","year")) %>% 
  as.data.frame() %>% 
  mutate(stage = factor(stage))

popdf %>% 
  ggplot(aes(x=year, y=value, color=stage)) + 
  geom_line() + 
  facet_wrap(~patch) +
  theme_bw() +
  scale_color_manual(values=c('blue','deeppink','cyan'))

```

Letting adults live more than 1 year

* Autoregressive recruitment process
* All individuals transition stages every year, modulated by a fixed mortality rate
* Adults accumulate (keep adults from last year less the same mortality rate as used for other stages)
* No dispersal 

```{r sim-ar-adults-live}

# generate data

pop_adults <- array(NA, dim = c(patches, stages, years))

pop_adults[,,1] <- round(n0) # initialize first year  

for (y in 2:years){
  
  pop_adults[,1,y] <- round(mean_rec * exp(rnorm(patches,-sigma_r^2/2, sigma_r))) # should we be keeping the recruits from last year that didn't grow? 
  
  pop_adults[,2,y] <-   round(pop[,1,y-1] * exp(-m)) # intermediate stage is just a function of recruits (assume all survivors transition stage)
  
  pop_adults[,3,y] <- round(pop[,2,y-1] * exp(-m)) + round(pop[,3,y-1] * exp(-m)) # sum adults and juveniles from previous year, minus mortality
  
}

pop_adultsdf <- pop_adults %>% 
  reshape::melt(varnames = c("patch","stage","year")) %>% 
  as.data.frame() %>% 
  mutate(stage = factor(stage))

pop_adultsdf %>% 
  ggplot(aes(x=year, y=value, color=stage)) + 
  geom_line() + 
  facet_wrap(~patch) +
  theme_bw() +
  scale_color_manual(values=c('blue','deeppink','cyan'))
```

Adding growth rates between stages

* Autoregressive recruitment process
* Change in classes 2 and 3 now a result of mortality and growth from previous stage (both fixed) 
* Adults accumulate (keep adults from last year less the same mortality rate as used for other stages)
* No dispersal 

```{r sim-ar-stage-growth}

gY <- 0.5 # transition rate into young adults

gA <- 0.5 # transition rate into adults

pop_growth <- array(NA, dim = c(patches, stages, years))

pop_growth[,,1] <- round(n0) # initialize first year  

for (y in 2:years){
  
  # recruits
  pop_growth[,1,y] <- round(mean_rec * exp(rnorm(patches,-sigma_r^2/2, sigma_r)))
  
  # young adults / large juvs
  pop_growth[,2,y] <- round(pop_growth[,1,y-1] * (1 - m) * gY) + # recruits, less mortality, plus growth into this stage
    round(pop_growth[,2,y-1] * (1 - m) * (1 - gA)) # this life stage last year less individuals that died or grew out 
  
  # adults
  pop_growth[,3,y] <- round(pop_growth[,2,y-1] * (1 - m) * gA) + # previous stage 
    round(pop_growth[,3,y-1] * (1 - m))
}

pop_growthdf <- pop_growth %>% 
  reshape::melt(varnames = c("patch","stage","year")) %>% 
  as.data.frame() %>% 
  mutate(stage = factor(stage))

pop_growthdf %>% 
  ggplot(aes(x=year, y=value, color=stage)) + 
  geom_line() + 
  facet_wrap(~patch) +
  theme_bw() +
  scale_color_manual(values=c('blue','deeppink','cyan'))
```

Adding dispersal

* Autoregressive recruitment process
* Change in classes 2 and 3 now a result of mortality and growth from previous stage (both fixed) 
* Adults accumulate (keep adults from last year less the same mortality rate as used for other stages)
* 10% of adults move to adjacent patches every year (passive spillover) 

```{r sim-ar-adult-dispersal}

gY <- 0.5 # transition rate into young adults

gA <- 0.5 # transition rate into adults

spill <- 0.1

pop_spill <- array(NA, dim = c(patches, stages, years))

pop_spill[,,1] <- round(n0) # initialize first year  

for (y in 2:years){
  
  # recruits
  pop_spill[,1,y] <- round(mean_rec * exp(rnorm(patches,-sigma_r^2/2, sigma_r)))
  
  # young adults / large juvs
  pop_spill[,2,y] <- round(pop_spill[,1,y-1] * (1 - m) * gY) + # recruits, less mortality, plus growth into this stage
    round(pop_spill[,2,y-1] * (1 - m) * (1 - gA)) # this life stage last year less individuals that died or grew out 
  
  for(p in 1:patches) {
    # adults
    
    # add reflecting cases for edge patches
    if(p == 1) {
      pop_spill[p,3,y] <- round(pop_spill[p,2,y-1] * (1 - m) * gA) + # young adults in patch
        round(pop_spill[p,3,y-1] * (1 - m) * (1 - spill)) + # adults in patch, minus mortality and spillover (only to one patch)
        round(pop_spill[p+1,3,y-1] * (1 - m) * spill) # and patch above
    }
    
    else if(p == patches) {
      pop_spill[p,3,y] <- round(pop_spill[p,2,y-1] * (1 - m) * gA) + # young adults in patch
        round(pop_spill[p,3,y-1] * (1 - m) * (1 - spill)) + # adults in patch, minus mortality and spillover (only to one patch)
        round(pop_spill[p-1,3,y-1] * (1 - m) * spill) # and patch below
    }
    
    else{
      pop_spill[p,3,y] <- round(pop_spill[p,2,y-1] * (1 - m) * gA) + # young adults in patch
        round(pop_spill[p,3,y-1] * (1 - m) * (1 - 2*spill)) + # adults in patch, minus mortality and spillover x2
        round(pop_spill[p-1,3,y-1] * (1 - m) * spill) + # add dispersal from patch below
        round(pop_spill[p+1,3,y-1] * (1 - m) * spill) # and patch above
    }
  }
}

pop_spilldf <- pop_spill %>% 
  reshape::melt(varnames = c("patch","stage","year")) %>% 
  as.data.frame() %>% 
  mutate(stage = factor(stage))

pop_spilldf %>% 
  ggplot(aes(x=year, y=value, color=stage)) + 
  geom_line() + 
  facet_wrap(~patch) +
  theme_bw() +
  scale_color_manual(values=c('blue','deeppink','cyan'))
```



```{r, eval=FALSE}
stage_data <- list(
  m = m,
  np = patches,
  ns = stages,
  ny = years_train,
  n_p_s_y = pop[,,1:years_train],
  proj_init = pop[,,years_train],
  ny_proj = years_proj
)

warmups <- 1000

total_iterations <- 2000

max_treedepth <-  12

n_chains <-  4

n_cores <- 4


stage_model_fit <- stan(file = here::here("src","stage_ar_model.stan"),
                        data = stage_data,
                        chains = n_chains,
                        warmup = warmups,
                        iter = total_iterations,
                        cores = n_cores,
                        refresh = 250,
                        control = list(max_treedepth = max_treedepth,
                                       adapt_delta = 0.95))


```

```{r, eval=FALSE}



mean_recruits_hat <- tidybayes::gather_draws(stage_model_fit, mean_recruits[patch], n = 1000)

mean_recruits <- tibble(patch = 1:patches, mean_recruits = mean_rec)

mean_recruits %>% 
  ggplot() + 
  geom_boxplot(data = mean_recruits_hat, aes(patch, .value, group = patch)) +
  geom_point(aes(patch, mean_recruits, color = "true"), size = 2) + 
  scale_y_continuous(name = "Mean Recruits") + 
  scale_x_continuous(name = "Patch")


n_p_s_y_hat <-  tidybayes::gather_draws(stage_model_fit, n_p_s_y_hat[patch, stage,year], n = 1000)

n_p_s_y <- pop %>% 
  reshape::melt(varnames = c("patch","stage","year")) %>% 
  as_tibble() 

eg_patch <- 10

n_p_s_y_hat %>% 
  filter(patch == eg_patch) %>% 
  ggplot() +
  stat_lineribbon(aes(x = stage, y = .value),.width = c(.9, .6)) +
  geom_point(data = n_p_s_y %>% filter(patch == eg_patch), aes(stage, value, color = "true")) +
  facet_wrap(~year, scales = "free") + 
  scale_y_continuous(name = "Numbers") + 
  labs(caption = glue::glue("for patch {eg_patch}"))

```


