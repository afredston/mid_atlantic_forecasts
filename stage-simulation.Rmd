---
title: "Simulating a process model with patches and stage structure"
author: "Alexa Fredston, Dan Ovando, Malin Pinsky"
date: "Begun Jan 2021"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r packages}
set.seed(42)
library(tidyverse)
library(tidybayes)

library(here)

library(rstan)
```


```{r prep}
patches <- 12

m <- 0.2 # I use this slightly differently in later sims (not exponentiated anymore)

stages <- 3

years <- 100
years_train <- 80
years_proj <- 20

alpha <- 0.5

sigma_r <- 0.2

mean_rec <- rlnorm(patches, log(20),1)

hist(mean_rec)

n0 <- mean_rec * matrix(rep(exp(-m * (0:(stages - 1))),patches), nrow = patches, ncol = stages, byrow = TRUE)
```

# Simple stage structure

## Simulate the data

* Autoregressive recruitment process
* All individuals transition stages every year, modulated by a fixed mortality rate
* Adults do not accumulate (implies death after reaching adulthood)
* No dispersal

```{r sim-ar-simple-stage}

# generate data

pop <- array(NA, dim = c(patches, stages, years))

pop[,,1] <- round(n0) # initialize first year  

for (y in 2:years){
  
  pop[,1,y] <- round(mean_rec * exp(rnorm(patches,-sigma_r^2/2, sigma_r))) # add recruits
  
  pop[,2:stages,y] <-   round(pop[,1:(stages-1),y-1] * exp(-m)) # currently assuming all individuals advance to the next stage every year 
  
}

popdf <- pop %>% 
  reshape::melt(varnames = c("patch","stage","year")) %>% 
  as.data.frame() %>% 
  mutate(stage = factor(stage))

popdf %>% 
  ggplot(aes(x=year, y=value, color=stage)) + 
  geom_line() + 
  facet_wrap(~patch) +
  theme_bw() +
  scale_color_manual(values=c('blue','deeppink','cyan'))

```

## Fit a model

```{r stage_ar_model}
stage_data <- list(
  m = m,
  np = patches,
  ns = stages,
  ny = years_train,
  n_p_s_y = pop[,,1:years_train],
  proj_init = pop[,,years_train],
  ny_proj = years_proj
)

warmups <- 1000

total_iterations <- 2000

max_treedepth <-  12

n_chains <-  4

n_cores <- 4 

stage_model_fit <- stan(file = here::here("src","stage_ar_model.stan"),
           data = stage_data,
           chains = n_chains,
           warmup = warmups,
           iter = total_iterations,
           cores = n_cores,
           refresh = 250,
           control = list(max_treedepth = max_treedepth,
                          adapt_delta = 0.95))


```

## Evaluate the model 

```{r}
mean_recruits_hat <- tidybayes::gather_draws(stage_model_fit, mean_recruits[patch], n = 1000)

mean_recruits <- tibble(patch = 1:patches, mean_recruits = mean_rec)

mean_recruits %>% 
  ggplot() + 
  geom_boxplot(data = mean_recruits_hat, aes(patch, .value, group = patch)) +
  geom_point(aes(patch, mean_recruits, color = "true"), size = 2) + 
  scale_y_continuous(name = "Mean Recruits") + 
  scale_x_continuous(name = "Patch")


n_p_s_y_hat <-  tidybayes::gather_draws(stage_model_fit, n_p_s_y_hat[patch, stage,year], n = 1000)

pp_n_p_s_y_hat <-  tidybayes::gather_draws(stage_model_fit, pp_n_p_s_y_hat[patch, stage,year], n = 1000)

pp_proj_n_p_s_y_hat <-  tidybayes::gather_draws(stage_model_fit, pp_proj_n_p_s_y_hat[patch, stage,year], n = 1000)

n_p_s_y <- pop[,,1:years_train] %>% 
  reshape::melt(varnames = c("patch","stage","year")) %>% 
  as_tibble() 


n_p_s_y_proj <- pop[,,(years_train+1):years] %>% 
  reshape::melt(varnames = c("patch","stage","year")) %>% 
  as_tibble() 
# 
# eg_patch <- 10
# 
# n_p_s_y_hat %>% 
#   filter(patch == eg_patch) %>% 
#   ggplot() +
#    stat_lineribbon(aes(x = stage, y = .value),.width = c(.9, .6)) +
#   geom_point(data = n_p_s_y %>% filter(patch == eg_patch), aes(stage, value, color = "true")) +
#   facet_wrap(~year, scales = "free") + 
#   scale_y_continuous(name = "Numbers") + 
#   labs(caption = glue::glue("for patch {eg_patch}"))


gg_n_p_s_y_hat <- n_p_s_y_hat %>% 
  ggplot() +
  stat_lineribbon(aes(x = year, y = .value, group=stage),.width = c(.99, .95, .8, .5), color = "red") +
  geom_point(data = n_p_s_y, aes(x=year, y=value, group=stage), size = 2,alpha = 0.5) + 
  facet_grid(patch~stage, scales = "free_y") + 
  scale_fill_brewer() +
  labs(title="model predictions")

# posterior predictive fits
gg_pp_n_p_s_y_hat <- pp_n_p_s_y_hat %>% 
  ggplot() +
  stat_lineribbon(aes(x = year, y = .value, group=stage),.width = c(.99, .95, .8, .5), color = "red") +
  geom_point(data = n_p_s_y, aes(x=year, y=value, group=stage), size = 2,alpha = 0.5) + 
  facet_grid(patch~stage, scales = "free_y") + 
  scale_fill_brewer()+
  labs(title="posterior predictive fit")

# forecast fits
gg_pp_proj_n_p_s_y_hat <- pp_proj_n_p_s_y_hat %>% 
  ggplot() +
  stat_lineribbon(aes(x = year, y = .value, group=stage),.width = c(.99, .95, .8, .5), color = "red") +
  geom_point(data = n_p_s_y_proj, aes(x=year, y=value, group=stage), size = 2,alpha = 0.5) + 
  facet_grid(patch~stage, scales = "free_y") + 
  scale_fill_brewer() +
  labs(title="forecast")

gg_n_p_s_y_hat
gg_pp_n_p_s_y_hat
gg_pp_proj_n_p_s_y_hat

ggsave(gg_n_p_s_y_hat, filename=here("results","stage_ar_model_fit.png"), width=7, height=10)
ggsave(gg_pp_n_p_s_y_hat, filename=here("results","stage_ar_model_pp.png"), width=7, height=10)
ggsave(gg_pp_proj_n_p_s_y_hat, filename=here("results","stage_ar_model_proj.png"), width=7, height=10)
```

# Letting adults live more than 1 year

## Simulate the data

* Autoregressive recruitment process
* All individuals transition stages every year, modulated by a fixed mortality rate
* Adults accumulate (keep adults from last year less the same mortality rate as used for other stages)
* No dispersal 

```{r sim-ar-adults-live}

# generate data

pop <- array(NA, dim = c(patches, stages, years))

pop[,,1] <- round(n0) # initialize first year  

for (y in 2:years){
  
  pop[,1,y] <- round(mean_rec * exp(rnorm(patches,-sigma_r^2/2, sigma_r))) # should we be keeping the recruits from last year that didn't grow? 
  
  pop[,2,y] <-   round(pop[,1,y-1] * exp(-m)) # intermediate stage is just a function of recruits (assume all survivors transition stage)
  
  pop[,3,y] <- round(pop[,2,y-1] * exp(-m)) + round(pop[,3,y-1] * exp(-m)) # sum adults and juveniles from previous year, minus mortality
  
}

popdf <- pop %>% 
  reshape::melt(varnames = c("patch","stage","year")) %>% 
  as.data.frame() %>% 
  mutate(stage = factor(stage))

popdf %>% 
  ggplot(aes(x=year, y=value, color=stage)) + 
  geom_line() + 
  facet_wrap(~patch) +
  theme_bw() +
  scale_color_manual(values=c('blue','deeppink','cyan'))
```

## Fit a model 


```{r stage_ar_model_adults_survive}
stage_data <- list(
  m = m,
  np = patches,
  ns = stages,
  ny = years_train,
  n_p_s_y = pop[,,1:years_train],
  proj_init = pop[,,years_train],
  ny_proj = years_proj
)

warmups <- 1000

total_iterations <- 2000

max_treedepth <-  12

n_chains <-  4

n_cores <- 4 

stage_model_fit <- stan(file = here::here("src","stage_ar_model_adults_survive.stan"),
           data = stage_data,
           chains = n_chains,
           warmup = warmups,
           iter = total_iterations,
           cores = n_cores,
           refresh = 250,
           control = list(max_treedepth = max_treedepth,
                          adapt_delta = 0.95))


```

## Evaluate the model

```{r}
mean_recruits_hat <- tidybayes::gather_draws(stage_model_fit, mean_recruits[patch], n = 1000)

mean_recruits <- tibble(patch = 1:patches, mean_recruits = mean_rec)

mean_recruits %>% 
  ggplot() + 
  geom_boxplot(data = mean_recruits_hat, aes(patch, .value, group = patch)) +
  geom_point(aes(patch, mean_recruits, color = "true"), size = 2) + 
  scale_y_continuous(name = "Mean Recruits") + 
  scale_x_continuous(name = "Patch")

n_p_s_y_hat <-  tidybayes::gather_draws(stage_model_fit, n_p_s_y_hat[patch, stage,year], n = 1000)

pp_n_p_s_y_hat <-  tidybayes::gather_draws(stage_model_fit, pp_n_p_s_y_hat[patch, stage,year], n = 1000)

pp_proj_n_p_s_y_hat <-  tidybayes::gather_draws(stage_model_fit, pp_proj_n_p_s_y_hat[patch, stage,year], n = 1000)

n_p_s_y <- pop[,,1:years_train] %>% 
  reshape::melt(varnames = c("patch","stage","year")) %>% 
  as_tibble() 


n_p_s_y_proj <- pop[,,(years_train+1):years] %>% 
  reshape::melt(varnames = c("patch","stage","year")) %>% 
  as_tibble() 
# 
# eg_patch <- 10
# 
# n_p_s_y_hat %>% 
#   filter(patch == eg_patch) %>% 
#   ggplot() +
#    stat_lineribbon(aes(x = stage, y = .value),.width = c(.9, .6)) +
#   geom_point(data = n_p_s_y %>% filter(patch == eg_patch), aes(stage, value, color = "true")) +
#   facet_wrap(~year, scales = "free") + 
#   scale_y_continuous(name = "Numbers") + 
#   labs(caption = glue::glue("for patch {eg_patch}"))


gg_n_p_s_y_hat <- n_p_s_y_hat %>% 
  ggplot() +
  stat_lineribbon(aes(x = year, y = .value, group=stage),.width = c(.99, .95, .8, .5), color = "red") +
  geom_point(data = n_p_s_y, aes(x=year, y=value, group=stage), size = 2,alpha = 0.5) + 
  facet_grid(patch~stage, scales = "free_y") + 
  scale_fill_brewer() +
  labs(title="model predictions")

# posterior predictive fits
gg_pp_n_p_s_y_hat <- pp_n_p_s_y_hat %>% 
  ggplot() +
  stat_lineribbon(aes(x = year, y = .value, group=stage),.width = c(.99, .95, .8, .5), color = "red") +
  geom_point(data = n_p_s_y, aes(x=year, y=value, group=stage), size = 2,alpha = 0.5) + 
  facet_grid(patch~stage, scales = "free_y") + 
  scale_fill_brewer()+
  labs(title="posterior predictive fit")

# forecast fits
gg_pp_proj_n_p_s_y_hat <- pp_proj_n_p_s_y_hat %>% 
  ggplot() +
  stat_lineribbon(aes(x = year, y = .value, group=stage),.width = c(.99, .95, .8, .5), color = "red") +
  geom_point(data = n_p_s_y_proj, aes(x=year, y=value, group=stage), size = 2,alpha = 0.5) + 
  facet_grid(patch~stage, scales = "free_y") + 
  scale_fill_brewer() +
  labs(title="forecast")

gg_n_p_s_y_hat
gg_pp_n_p_s_y_hat
gg_pp_proj_n_p_s_y_hat

ggsave(gg_n_p_s_y_hat, filename=here("results","stage_ar_model_adults_survive_fit.png"), width=7, height=10)
ggsave(gg_pp_n_p_s_y_hat, filename=here("results","stage_ar_model_adults_survive_pp.png"), width=7, height=10)
ggsave(gg_pp_proj_n_p_s_y_hat, filename=here("results","stage_ar_model_adults_survive_proj.png"), width=7, height=10)
```


# Adding growth rates between stages

* Autoregressive recruitment process
* Change in classes 2 and 3 now a result of mortality and growth from previous stage (both fixed) 
* Adults and young adults accumulate (keep pop. from last year less the same mortality rate as used for other stages, and in the case of young adults, less the proportion that grew to adults)
* No dispersal 

## Simulate the data 
```{r sim-ar-stage-growth}

gY <- 0.5 # transition rate into young adults

gA <- 0.5 # transition rate into adults

pop <- array(NA, dim = c(patches, stages, years))

pop[,,1] <- round(n0) # initialize first year  

for (y in 2:years){
  
  # recruits
  pop[,1,y] <- round(mean_rec * exp(rnorm(patches,-sigma_r^2/2, sigma_r)))
  
  # young adults / large juvs
  pop[,2,y] <- round(pop[,1,y-1] * (1 - m) * gY) + # recruits, less mortality, plus growth into this stage
    round(pop[,2,y-1] * (1 - m) * (1 - gA)) # this life stage last year less individuals that died or grew out 
  
  # adults
  pop[,3,y] <- round(pop[,2,y-1] * (1 - m) * gA) + # previous stage 
    round(pop[,3,y-1] * (1 - m))
}

popdf <- pop %>% 
  reshape::melt(varnames = c("patch","stage","year")) %>% 
  as.data.frame() %>% 
  mutate(stage = factor(stage))

popdf %>% 
  ggplot(aes(x=year, y=value, color=stage)) + 
  geom_line() + 
  facet_wrap(~patch) +
  theme_bw() +
  scale_color_manual(values=c('blue','deeppink','cyan'))
```

## Fit a model


```{r stage_ar_model_growth_rates}
stage_data <- list(
  m = m,
  gY = gY,
  gA = gA,
  np = patches,
  ns = stages,
  ny = years_train,
  n_p_s_y = pop[,,1:years_train],
  proj_init = pop[,,years_train],
  ny_proj = years_proj
)

warmups <- 1000

total_iterations <- 2000

max_treedepth <-  12

n_chains <-  4

n_cores <- 4 

stage_model_fit <- stan(file = here::here("src","stage_ar_model_growth_rates.stan"),
           data = stage_data,
           chains = n_chains,
           warmup = warmups,
           iter = total_iterations,
           cores = n_cores,
           refresh = 250,
           control = list(max_treedepth = max_treedepth,
                          adapt_delta = 0.95))


```

## Evaluate the model


```{r}
mean_recruits_hat <- tidybayes::gather_draws(stage_model_fit, mean_recruits[patch], n = 1000)

mean_recruits <- tibble(patch = 1:patches, mean_recruits = mean_rec)

mean_recruits %>% 
  ggplot() + 
  geom_boxplot(data = mean_recruits_hat, aes(patch, .value, group = patch)) +
  geom_point(aes(patch, mean_recruits, color = "true"), size = 2) + 
  scale_y_continuous(name = "Mean Recruits") + 
  scale_x_continuous(name = "Patch")

n_p_s_y_hat <-  tidybayes::gather_draws(stage_model_fit, n_p_s_y_hat[patch, stage,year], n = 1000)

pp_n_p_s_y_hat <-  tidybayes::gather_draws(stage_model_fit, pp_n_p_s_y_hat[patch, stage,year], n = 1000)

pp_proj_n_p_s_y_hat <-  tidybayes::gather_draws(stage_model_fit, pp_proj_n_p_s_y_hat[patch, stage,year], n = 1000)

n_p_s_y <- pop[,,1:years_train] %>% 
  reshape::melt(varnames = c("patch","stage","year")) %>% 
  as_tibble() 


n_p_s_y_proj <- pop[,,(years_train+1):years] %>% 
  reshape::melt(varnames = c("patch","stage","year")) %>% 
  as_tibble() 
# 
# eg_patch <- 10
# 
# n_p_s_y_hat %>% 
#   filter(patch == eg_patch) %>% 
#   ggplot() +
#    stat_lineribbon(aes(x = stage, y = .value),.width = c(.9, .6)) +
#   geom_point(data = n_p_s_y %>% filter(patch == eg_patch), aes(stage, value, color = "true")) +
#   facet_wrap(~year, scales = "free") + 
#   scale_y_continuous(name = "Numbers") + 
#   labs(caption = glue::glue("for patch {eg_patch}"))


gg_n_p_s_y_hat <- n_p_s_y_hat %>% 
  ggplot() +
  stat_lineribbon(aes(x = year, y = .value, group=stage),.width = c(.99, .95, .8, .5), color = "red") +
  geom_point(data = n_p_s_y, aes(x=year, y=value, group=stage), size = 2,alpha = 0.5) + 
  facet_grid(patch~stage, scales = "free_y") + 
  scale_fill_brewer() +
  labs(title="model predictions")

# posterior predictive fits
gg_pp_n_p_s_y_hat <- pp_n_p_s_y_hat %>% 
  ggplot() +
  stat_lineribbon(aes(x = year, y = .value, group=stage),.width = c(.99, .95, .8, .5), color = "red") +
  geom_point(data = n_p_s_y, aes(x=year, y=value, group=stage), size = 2,alpha = 0.5) + 
  facet_grid(patch~stage, scales = "free_y") + 
  scale_fill_brewer()+
  labs(title="posterior predictive fit")

# forecast fits
gg_pp_proj_n_p_s_y_hat <- pp_proj_n_p_s_y_hat %>% 
  ggplot() +
  stat_lineribbon(aes(x = year, y = .value, group=stage),.width = c(.99, .95, .8, .5), color = "red") +
  geom_point(data = n_p_s_y_proj, aes(x=year, y=value, group=stage), size = 2,alpha = 0.5) + 
  facet_grid(patch~stage, scales = "free_y") + 
  scale_fill_brewer() +
  labs(title="forecast")

gg_n_p_s_y_hat
gg_pp_n_p_s_y_hat
gg_pp_proj_n_p_s_y_hat

ggsave(gg_n_p_s_y_hat, filename=here("results","stage_ar_model_growth_rates_fit.png"), width=7, height=10)
ggsave(gg_pp_n_p_s_y_hat, filename=here("results","stage_ar_model_growth_rates_pp.png"), width=7, height=10)
ggsave(gg_pp_proj_n_p_s_y_hat, filename=here("results","stage_ar_model_growth_rates_proj.png"), width=7, height=10)
```

#Adding dispersal

* Autoregressive recruitment process
* Change in classes 2 and 3 now a result of mortality and growth from previous stage (both fixed) 
* Adults and young adults accumulate (keep pop. from last year less the same mortality rate as used for other stages, and in the case of young adults, less the proportion that grew to adults)
* 10% of adults move to adjacent patches every year (passive spillover) 

## Simulate the data 

```{r sim-ar-adult-dispersal}

gY <- 0.5 # transition rate into young adults

gA <- 0.5 # transition rate into adults

spill <- 0.1

pop <- array(NA, dim = c(patches, stages, years))

pop[,,1] <- round(n0) # initialize first year  

for (y in 2:years){
  
  # recruits
  pop[,1,y] <- round(mean_rec * exp(rnorm(patches,-sigma_r^2/2, sigma_r)))
  
  # young adults / large juvs
  pop[,2,y] <- round(pop[,1,y-1] * (1 - m) * gY) + # recruits, less mortality, plus growth into this stage
    round(pop[,2,y-1] * (1 - m) * (1 - gA)) # this life stage last year less individuals that died or grew out 
  
  for(p in 1:patches) {
    # adults
    
    # add reflecting cases for edge patches
    if(p == 1) {
      pop[p,3,y] <- round(pop[p,2,y-1] * (1 - m) * gA) + # young adults in patch
        round(pop[p,3,y-1] * (1 - m) * (1 - spill)) + # adults in patch, minus mortality and spillover (only to one patch)
        round(pop[p+1,3,y-1] * (1 - m) * spill) # and patch above
    }
    
    else if(p == patches) {
      pop[p,3,y] <- round(pop[p,2,y-1] * (1 - m) * gA) + # young adults in patch
        round(pop[p,3,y-1] * (1 - m) * (1 - spill)) + # adults in patch, minus mortality and spillover (only to one patch)
        round(pop[p-1,3,y-1] * (1 - m) * spill) # and patch below
    }
    
    else{
      pop[p,3,y] <- round(pop[p,2,y-1] * (1 - m) * gA) + # young adults in patch
        round(pop[p,3,y-1] * (1 - m) * (1 - 2*spill)) + # adults in patch, minus mortality and spillover x2
        round(pop[p-1,3,y-1] * (1 - m) * spill) + # add dispersal from patch below
        round(pop[p+1,3,y-1] * (1 - m) * spill) # and patch above
    }
  }
}

popdf <- pop %>% 
  reshape::melt(varnames = c("patch","stage","year")) %>% 
  as.data.frame() %>% 
  mutate(stage = factor(stage))

popdf %>% 
  ggplot(aes(x=year, y=value, color=stage)) + 
  geom_line() + 
  facet_wrap(~patch) +
  theme_bw() +
  scale_color_manual(values=c('blue','deeppink','cyan'))
```

## Fit a model

```{r stage_ar_model_adult_dispersal}
stage_data <- list(
  m = m,
  gY = gY,
  gA = gA,
  spill = spill,
  np = patches,
  ns = stages,
  ny = years_train,
  n_p_s_y = pop[,,1:years_train],
  proj_init = pop[,,years_train],
  ny_proj = years_proj
)

warmups <- 1000

total_iterations <- 2000

max_treedepth <-  12

n_chains <-  4

n_cores <- 4 

stage_model_fit <- stan(file = here::here("src","stage_ar_model_adult_dispersal.stan"),
           data = stage_data,
           chains = n_chains,
           warmup = warmups,
           iter = total_iterations,
           cores = n_cores,
           refresh = 250,
           control = list(max_treedepth = max_treedepth,
                          adapt_delta = 0.95))


```

## Evaluate the model

```{r}
mean_recruits_hat <- tidybayes::gather_draws(stage_model_fit, mean_recruits[patch], n = 1000)

mean_recruits <- tibble(patch = 1:patches, mean_recruits = mean_rec)

mean_recruits %>% 
  ggplot() + 
  geom_boxplot(data = mean_recruits_hat, aes(patch, .value, group = patch)) +
  geom_point(aes(patch, mean_recruits, color = "true"), size = 2) + 
  scale_y_continuous(name = "Mean Recruits") + 
  scale_x_continuous(name = "Patch")

n_p_s_y_hat <-  tidybayes::gather_draws(stage_model_fit, n_p_s_y_hat[patch, stage,year], n = 1000)

pp_n_p_s_y_hat <-  tidybayes::gather_draws(stage_model_fit, pp_n_p_s_y_hat[patch, stage,year], n = 1000)

pp_proj_n_p_s_y_hat <-  tidybayes::gather_draws(stage_model_fit, pp_proj_n_p_s_y_hat[patch, stage,year], n = 1000)

n_p_s_y <- pop[,,1:years_train] %>% 
  reshape::melt(varnames = c("patch","stage","year")) %>% 
  as_tibble() 


n_p_s_y_proj <- pop[,,(years_train+1):years] %>% 
  reshape::melt(varnames = c("patch","stage","year")) %>% 
  as_tibble() 
# 
# eg_patch <- 10
# 
# n_p_s_y_hat %>% 
#   filter(patch == eg_patch) %>% 
#   ggplot() +
#    stat_lineribbon(aes(x = stage, y = .value),.width = c(.9, .6)) +
#   geom_point(data = n_p_s_y %>% filter(patch == eg_patch), aes(stage, value, color = "true")) +
#   facet_wrap(~year, scales = "free") + 
#   scale_y_continuous(name = "Numbers") + 
#   labs(caption = glue::glue("for patch {eg_patch}"))


gg_n_p_s_y_hat <- n_p_s_y_hat %>% 
  ggplot() +
  stat_lineribbon(aes(x = year, y = .value, group=stage),.width = c(.99, .95, .8, .5), color = "red") +
  geom_point(data = n_p_s_y, aes(x=year, y=value, group=stage), size = 2,alpha = 0.5) + 
  facet_grid(patch~stage, scales = "free_y") + 
  scale_fill_brewer() +
  labs(title="model predictions")

# posterior predictive fits
gg_pp_n_p_s_y_hat <- pp_n_p_s_y_hat %>% 
  ggplot() +
  stat_lineribbon(aes(x = year, y = .value, group=stage),.width = c(.99, .95, .8, .5), color = "red") +
  geom_point(data = n_p_s_y, aes(x=year, y=value, group=stage), size = 2,alpha = 0.5) + 
  facet_grid(patch~stage, scales = "free_y") + 
  scale_fill_brewer()+
  labs(title="posterior predictive fit")

# forecast fits
gg_pp_proj_n_p_s_y_hat <- pp_proj_n_p_s_y_hat %>% 
  ggplot() +
  stat_lineribbon(aes(x = year, y = .value, group=stage),.width = c(.99, .95, .8, .5), color = "red") +
  geom_point(data = n_p_s_y_proj, aes(x=year, y=value, group=stage), size = 2,alpha = 0.5) + 
  facet_grid(patch~stage, scales = "free_y") + 
  scale_fill_brewer() +
  labs(title="forecast")

gg_n_p_s_y_hat
gg_pp_n_p_s_y_hat
gg_pp_proj_n_p_s_y_hat

ggsave(gg_n_p_s_y_hat, filename=here("results","stage_ar_model_growth_rates_fit.png"), width=7, height=10)
ggsave(gg_pp_n_p_s_y_hat, filename=here("results","stage_ar_model_growth_rates_pp.png"), width=7, height=10)
ggsave(gg_pp_proj_n_p_s_y_hat, filename=here("results","stage_ar_model_growth_rates_proj.png"), width=7, height=10)
```

# Adding temperature dependence

* Autoregressive recruitment process
* Change in classes 2 and 3 now a result of mortality and growth from previous stage (growth is now temperature dependent) 
* Adults accumulate (keep adults from last year less the same mortality rate as used for other stages)
* 10% of adults move to adjacent patches every year (passive spillover) 

```{r sim-ar-T-dep-growth}

width <- 5 # sensitivity to temperature variation 

sstopt <- 18 # temp at which growth is maximized

growth <- function(sst) {exp(-0.5 * ((sst - sstopt)/width)^2)}

spill <- 0.1

sst <- array(NA, dim = c(patches, years))
gY <- array(NA, dim = c(patches, years))
gA <- array(NA, dim = c(patches, years))
tmp <- sort(1:patches, decreasing=TRUE) # flip order so the highest sst is at the lowest patches (representing lat)

for(p in 1:patches){
  for(y in 1:years){
    sst[p, y] <- rnorm(n=1, mean=(tmp[p]+10), sd=3) # adding vaguely realistic SSTs for the mid-Atlantic
    gY[p, y] <- growth(sst[p, y]) # calculate array of growth rates 
    gA[p, y] <- growth(sst[p, y])
    
  }
}

pop_Tgrowth <- array(NA, dim = c(patches, stages, years))

pop_Tgrowth[,,1] <- round(n0) # initialize first year  

for (y in 2:years){
  for(p in 1:patches) {
    # recruits
    pop_Tgrowth[,1,y] <- round(mean_rec * exp(rnorm(patches,-sigma_r^2/2, sigma_r)))
    
    # young adults / large juvs
    pop_Tgrowth[p,2,y] <- round(pop_Tgrowth[p,1,y-1] * (1 - m) * gY[p, y-1]) + # recruits, less mortality, plus growth into this stage
      round(pop_Tgrowth[p,2,y-1] * (1 - m) * (1 - gA[p, y-1])) # this life stage last year less individuals that died or grew out 
    
    # adults
    
    # add reflecting cases for edge patches
    if(p == 1) {
      pop_Tgrowth[p,3,y] <- round(pop_Tgrowth[p,2,y-1] * (1 - m) * gA[p, y-1]) + # young adults in patch
        round(pop_Tgrowth[p,3,y-1] * (1 - m) * (1 - spill)) + # adults in patch, minus mortality and spillover (only to one patch)
        round(pop_Tgrowth[p+1,3,y-1] * (1 - m) * spill) # and patch above
    }
    
    else if(p == patches) {
      pop_Tgrowth[p,3,y] <- round(pop_Tgrowth[p,2,y-1] * (1 - m) * gA[p, y-1]) + # young adults in patch
        round(pop_Tgrowth[p,3,y-1] * (1 - m) * (1 - spill)) + # adults in patch, minus mortality and spillover (only to one patch)
        round(pop_Tgrowth[p-1,3,y-1] * (1 - m) * spill) # and patch below
    }
    
    else{
      pop_Tgrowth[p,3,y] <- round(pop_Tgrowth[p,2,y-1] * (1 - m) * gA[p, y-1]) + # young adults in patch
        round(pop_Tgrowth[p,3,y-1] * (1 - m) * (1 - 2*spill)) + # adults in patch, minus mortality and spillover x2
        round(pop_Tgrowth[p-1,3,y-1] * (1 - m) * spill) + # add dispersal from patch below
        round(pop_Tgrowth[p+1,3,y-1] * (1 - m) * spill) # and patch above
    }
  }
}

pop_Tgrowthdf <- pop_Tgrowth %>% 
  reshape::melt(varnames = c("patch","stage","year")) %>% 
  as.data.frame() %>% 
  mutate(stage = factor(stage))

# plot lat temp gradient

sst %>% 
  reshape::melt(varnames=c("patch","year")) %>% 
  ggplot(aes(x=year, y=value, color=value)) + 
  facet_wrap(~patch) + 
  geom_line()+
  labs(y="sst")

pop_Tgrowthdf %>% 
  ggplot(aes(x=year, y=value, color=stage)) + 
  geom_line() + 
  facet_wrap(~patch) +
  theme_bw() +
  scale_color_manual(values=c('blue','deeppink','cyan'))+
  labs(y="abundance")
```

Adding climate change

* Autoregressive recruitment process
* Change in classes 2 and 3 now a result of mortality and growth from previous stage (growth is now temperature dependent) 
* Adults accumulate (keep adults from last year less the same mortality rate as used for other stages)
* 10% of adults move to adjacent patches every year (passive spillover) 
* After 50 years, temperature starts increasing everywhere

```{r sim-ar-CC}

width <- 4 # sensitivity to temperature variation 

sstopt <- 18 # temp at which growth is maximized

growth <- function(sst) {exp(-0.5 * ((sst - sstopt)/width)^2)}
plot(seq(1, 100, 1), growth(seq(1, 100, 1))) # check how this works

spill <- 0.1

sst <- array(NA, dim = c(patches, years))
gY <- array(NA, dim = c(patches, years))
gA <- array(NA, dim = c(patches, years))

tmp <- sort(1:patches, decreasing=TRUE) # flip order so the highest sst is at the lowest patches (representing lat)
for(p in 1:patches){
  for(y in 1:years){
    
    if(y < 50){
      sst[p, y] <- rnorm(n=1, mean=(tmp[p]+10), sd=3)
    } # adding vaguely realistic SSTs for the mid-Atlantic
    
    else{
      sst[p, y] <- rnorm(n=1, mean=(tmp[p]+10), sd=3)*exp(y / 200) # adding warming; rescaling exponent to something sane
    }
    gY[p, y] <- growth(sst[p, y]) # calculate array of growth rates 
    gA[p, y] <- growth(sst[p, y]) 
  }
}

pop_cc <- array(NA, dim = c(patches, stages, years))

pop_cc[,,1] <- round(n0) # initialize first year  

for (y in 2:years){
  for(p in 1:patches) {
    # recruits
    pop_cc[,1,y] <- round(mean_rec * exp(rnorm(patches,-sigma_r^2/2, sigma_r)))
    
    # young adults / large juvs
    pop_cc[p,2,y] <- round(pop_cc[p,1,y-1] * (1 - m) * gY[p, y-1]) + # recruits, less mortality, plus growth into this stage
      round(pop_cc[p,2,y-1] * (1 - m) * (1 - gA[p, y-1])) # this life stage last year less individuals that died or grew out 
    
    # adults
    
    # add reflecting cases for edge patches
    if(p == 1) {
      pop_cc[p,3,y] <- round(pop_cc[p,2,y-1] * (1 - m) * gA[p, y-1]) + # growth from young adults in patch
        round(pop_cc[p,3,y-1] * (1 - m) * (1 - spill)) + # adults in patch, minus mortality and spillover (only to one patch)
        round(pop_cc[p+1,3,y-1] * (1 - m) * spill) # and patch above
    }
    
    else if(p == patches) {
      pop_cc[p,3,y] <- round(pop_cc[p,2,y-1] * (1 - m) * gA[p, y-1]) + # growth from young adults in patch
        round(pop_cc[p,3,y-1] * (1 - m) * (1 - spill)) + # adults in patch, minus mortality and spillover (only to one patch)
        round(pop_cc[p-1,3,y-1] * (1 - m) * spill) # and patch below
    }
    
    else{
      pop_cc[p,3,y] <- round(pop_cc[p,2,y-1] * (1 - m) * gA[p, y-1]) + # growth from young adults in patch
        round(pop_cc[p,3,y-1] * (1 - m) * (1 - 2*spill)) + # adults in patch, minus mortality and spillover x2
        round(pop_cc[p-1,3,y-1] * (1 - m) * spill) + # add dispersal from patch below
        round(pop_cc[p+1,3,y-1] * (1 - m) * spill) # and patch above
    }
  }
}

pop_ccdf <- pop_cc %>% 
  reshape::melt(varnames = c("patch","stage","year")) %>% 
  as.data.frame() %>% 
  mutate(stage = factor(stage))

# plot lat temp gradient

sst %>% 
  reshape::melt(varnames=c("patch","year")) %>% 
  ggplot(aes(x=year, y=value, color=value)) + 
  facet_wrap(~patch) + 
  geom_line() +
  labs(y="sst")

pop_ccdf %>% 
  ggplot(aes(x=year, y=value, color=stage)) + 
  geom_line() + 
  facet_wrap(~patch) +
  theme_bw() +
  scale_color_manual(values=c('blue','deeppink','cyan')) +
  labs(y="abundance")
```


```{r, eval=TRUE}
stage_data <- list(
  m = m,
  np = patches,
  ns = stages,
  ny = years_train,
  n_p_s_y = pop[,,1:years_train],
  proj_init = pop[,,years_train],
  ny_proj = years_proj
)

warmups <- 1000

total_iterations <- 2000

max_treedepth <-  12

n_chains <-  4

n_cores <- 4


stage_model_fit <- stan(file = here::here("src","stage_ar_model.stan"),
                        data = stage_data,
                        chains = n_chains,
                        warmup = warmups,
                        iter = total_iterations,
                        cores = n_cores,
                        refresh = 250,
                        control = list(max_treedepth = max_treedepth,
                                       adapt_delta = 0.95))


```

```{r, eval=TRUE}



mean_recruits_hat <- tidybayes::gather_draws(stage_model_fit, mean_recruits[patch], n = 1000)

mean_recruits <- tibble(patch = 1:patches, mean_recruits = mean_rec)

mean_recruits %>% 
  ggplot() + 
  geom_boxplot(data = mean_recruits_hat, aes(patch, .value, group = patch)) +
  geom_point(aes(patch, mean_recruits, color = "true"), size = 2) + 
  scale_y_continuous(name = "Mean Recruits") + 
  scale_x_continuous(name = "Patch")


n_p_s_y_hat <-  tidybayes::gather_draws(stage_model_fit, n_p_s_y_hat[patch, stage,year], n = 1000)

n_p_s_y <- pop %>% 
  reshape::melt(varnames = c("patch","stage","year")) %>% 
  as_tibble() 

eg_patch <- 10

n_p_s_y_hat %>% 
  filter(patch == eg_patch, year > 90) %>% 
  ggplot() +
  stat_lineribbon(aes(x = stage, y = .value),.width = c(.9, .6)) +
  geom_point(data = n_p_s_y %>% filter(patch == eg_patch, year > 90), aes(stage, value, color = "true")) +
  facet_wrap(~year, scales = "free") + 
  scale_y_continuous(name = "Numbers") + 
  labs(caption = glue::glue("for patch {eg_patch}"))

```


