---
title: "hierarchical_model"
author: "Alexa Fredston-Hermann and Malin Pinsky"
date: "10/30/2020"
output: html_document
---

Credit to the SESYNCBayes course (materials [here](https://cchecastaldo.github.io/BayesianShortCourse/Syllabus.html), code [here](https://github.com/CCheCastaldo/BayesianShortCourse)) for `rjags` instruction and code. 


```{r, eval=TRUE}
library(rjags)
library(tidyverse)
library(here)
library(MCMCvis)
#library(SESYNCBayes) # for comparing to class notes 

dogfish <- read_csv(here("processed-data","dogfish_prepped_data.csv"))

dogfishTest <- dogfish %>% 
  filter(lengthclass=="adult") %>% 
  group_by(year) %>% 
  summarise(estN = sum(numlengthclass),
            haulN = length(unique(haulid))) %>% 
  arrange(year) %>% 
  mutate(estNlag = lag(estN, n=1)) %>% # create N-1 column for model
  filter(year > min(year)) 

```

Specify model structure
Based on https://arxiv.org/src/2002.02001v1/anc/Appendix_S1.pdf p. 72

This takes a few seconds to run on my laptop.

``` {r JAGS1, eval = TRUE, include = TRUE, echo = TRUE}

toyOpJags <- " 
model {
  
  # priors
  
  # sd to precision
  obs.precision <- 1/(sdo*sdo)
  
  # process model
  N[1] ~ dpois(z0) # first time step based on known z0
  for(t in 2:lenT) { # remaining timesteps
    
    #lambda[t] <- N[t-1] * exp(r - r * N[t-1] / K)  # Ricker growth 
    lambda[t] <- N[t-1]
    N[t] ~ dpois(lambda[t]) # process error
  
  }
  
  # observation model
  for(t in 1:lenT){
    y[t] ~ dnorm(N[t],obs.precision)
  }
} 

"
```

``` {r run JAGS1, eval = TRUE, include = TRUE, echo = TRUE}
dataOpJags <- list(lenT=nrow(dogfishTest), y=as.double(dogfishTest$estN), z0=round(mean(dogfishTest$estN[1])), sdo=10)

# Set up initial values for each chain
ncOpJags <- 3
initvalOpJags <- list()
for(i in 1:ncOpJags) {
  Ninit <- numeric(dataOpJags$lenT)
  Ninit[1] <- rpois(1, dataOpJags$z0)
  for(t in 2:dataOpJags$lenT) {
    Ninit[t] <-rpois(1, Ninit[t-1])
  }
  initvalOpJags[[i]] <- list(N=Ninit)
}

# define chain lengths
burnOpJags <- 1000
inferOpJags <- 10000

# Call to JAGS
set.seed(1)
mOpJags <- jags.model(file=textConnection(object=toyOpJags),
                      data=dataOpJags,
                      inits=initvalOpJags,
                      n.chains=ncOpJags)
update(mOpJags, n.iter = burnOpJags)
jagspOVarM <- c("N")
fOpJags <- coda.samples(mOpJags,
                        variable.names=jagspOVarM,
                        n.iter=inferOpJags)
MCMCsummary(fOpJags)
MCMCplot(fOpJags, params = c("N"))
MCMCtrace(fOpJags, params = 'N\\[10\\]', pdf = FALSE, ISB = FALSE)
```
```{r plot estimates and data}
# get mean state estimates
zsOpJags <- apply(as.matrix(fOpJags)[,paste0("N[",1:dataOpJags$lenT,"]")],2,mean)

plot(1:dataOpJags$lenT, dataOpJags$y,
     pch=3, cex = 0.8, col=grey(0.4), ty="o",
     xlab = "t", ylab = expression(N[t]),
     xlim = c(0,dataOpJags$lenT),
     las = 1)
points(1:dataOpJags$lenT, zsOpJags, cex=0.6, col="blue", pch=19)
legend("top",
       legend = c("Obs", "Smooth states"),
       pch = c(3, 19),
       col = c("black", "blue"),
       horiz=TRUE, bty="n", cex=0.9)
```